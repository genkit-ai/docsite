---
import Default from '@astrojs/starlight/components/Head.astro';

const { title } = Astro.locals.starlightRoute.entry.data;
const id = Astro.locals.starlightRoute.entry["id"];
const { head } = Astro.locals.starlightRoute;

let finalTitle = title;
if (id.startsWith('go/')) {
    finalTitle = title + ' - Go - Genkit';
}
if (id.startsWith('python/')) {
    finalTitle = title + ' - Python - Genkit' ;
}
if (id.startsWith('docs/')) {
    finalTitle = title + ' - JS - Genkit';
}

// Generate canonical URL (always without lang parameter for SEO)
const canonicalUrl = new URL(Astro.url.pathname, Astro.site);

// Generate meta description based on page content
let metaDescription = "Build AI-powered applications with Genkit, Google's open-source framework for JavaScript, Go, and Python. Get started with flows, prompts, and integrations.";
if (id.startsWith('unified-docs/get-started')) {
  metaDescription = "Learn how to get started with Genkit for JavaScript, Go, and Python. Build AI workflows with Google's framework in minutes.";
} else if (id.startsWith('unified-docs/')) {
  metaDescription = `${title} - Build AI applications with Genkit. Comprehensive documentation for JavaScript, Go, and Python developers.`;
} else if (id.startsWith('go/')) {
  metaDescription = `${title} - Genkit for Go developers. Build AI-powered applications with Google's Go framework.`;
} else if (id.startsWith('python/')) {
  metaDescription = `${title} - Genkit for Python developers. Create AI workflows with Google's Python framework.`;
} else if (id.startsWith('docs/')) {
  metaDescription = `${title} - Genkit for JavaScript developers. Build AI applications with Google's TypeScript/JavaScript framework.`;
}

// Generate structured data (JSON-LD)
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "TechnicalArticle",
      "headline": finalTitle,
      "description": metaDescription,
      "url": canonicalUrl.href,
      "datePublished": "2024-01-01",
      "dateModified": new Date().toISOString().split('T')[0],
      "author": {
        "@type": "Organization",
        "name": "Google",
        "url": "https://google.com"
      },
      "publisher": {
        "@type": "Organization",
        "name": "Google",
        "url": "https://google.com",
        "logo": {
          "@type": "ImageObject",
          "url": "https://genkit.dev/ogimage.png"
        }
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": canonicalUrl.href
      },
      "about": {
        "@type": "SoftwareApplication",
        "name": "Genkit",
        "description": "Google's open-source framework for building AI-powered applications",
        "applicationCategory": "DeveloperApplication",
        "operatingSystem": "Cross-platform",
        "programmingLanguage": ["JavaScript", "TypeScript", "Go", "Python"],
        "url": "https://genkit.dev",
        "author": {
          "@type": "Organization",
          "name": "Google"
        }
      }
    },
    {
      "@type": "BreadcrumbList",
      "itemListElement": (() => {
        const pathParts = Astro.url.pathname.split('/').filter(Boolean);
        return pathParts.map((part, index) => ({
          "@type": "ListItem",
          "position": index + 1,
          "name": part.charAt(0).toUpperCase() + part.slice(1).replace(/-/g, ' '),
          "item": `${Astro.site}${pathParts.slice(0, index + 1).join('/')}/`
        }));
      })()
    }
  ]
};
---
<title>{finalTitle}</title>
<meta name="description" content={metaDescription} />
<link rel="canonical" href={canonicalUrl.href} />

<!-- Enhanced Open Graph tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content={finalTitle} />
<meta property="og:description" content={metaDescription} />
<meta property="og:url" content={canonicalUrl.href} />
<meta property="og:locale" content="en_US" />

<!-- Twitter Card tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={finalTitle} />
<meta name="twitter:description" content={metaDescription} />

<!-- Structured Data (JSON-LD) -->
<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

<!-- Font Preloading for Core Web Vitals -->
<link rel="preload" href="https://fonts.gstatic.com/s/googlesans/v14/4UaGrENHsxJlGDuGo1OIlL3Owp5eKQtGBlc.woff2" as="font" type="font/woff2" crossorigin />
<link rel="preload" href="https://fonts.gstatic.com/s/googlesanstext/v11/tuOiYllFfxv75qZnXgdNjXr6DgVDWVAuqQ.woff2" as="font" type="font/woff2" crossorigin />

{head.filter(({ tag }) => tag !== 'title').map(({ tag: Tag, attrs, content }) => <Tag {...attrs} set:html={content} />)}

<!-- Load unified page manager -->
<script is:inline>
// Inline the unified page manager to ensure it loads immediately
/**
 * Unified Page Manager for Genkit Documentation
 * 
 * This script coordinates:
 * 1. Scroll restoration without flashing
 * 2. Language preference management
 * 3. Smooth page transitions
 * 4. Font loading optimization
 */

class UnifiedPageManager {
  constructor() {
    this.storageKeys = {
      scroll: 'genkit-scroll-',
      language: 'genkit-preferred-language'
    };
    this.languages = ['JavaScript', 'Go', 'Python'];
    this.defaultLanguage = 'JavaScript';
    this.isInitialized = false;
    this.isRestoring = false;
    
    // Initialize immediately
    this.init();
  }

  init() {
    if (this.isInitialized) return;
    
    // Disable browser's automatic scroll restoration
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }
    
    // Check for scroll restoration needs
    const scrollKey = this.storageKeys.scroll + window.location.pathname;
    const savedScroll = sessionStorage.getItem(scrollKey);
    const storedScrollPosition = savedScroll ? parseInt(savedScroll, 10) : null;
    
    if (storedScrollPosition && storedScrollPosition > 0) {
      this.isRestoring = true;
      // Only hide the main content area, not the entire page
      document.documentElement.classList.add('scroll-restoring');
      sessionStorage.removeItem(scrollKey);
    }
    
    // Set up language immediately
    this.setupLanguage();
    
    // Set up scroll restoration
    if (this.isRestoring) {
      this.restoreScrollPosition(storedScrollPosition);
    }
    
    // Set up event listeners
    this.setupEventListeners();
    
    this.isInitialized = true;
  }

  setupLanguage() {
    // Get language from URL or storage
    const params = new URLSearchParams(window.location.search);
    const urlLang = params.get('lang');
    const storedLang = localStorage.getItem(this.storageKeys.language);
    const currentLang = urlLang || storedLang || 'js';
    
    // Normalize language value
    const normalizedLang = this.normalizeLanguage(currentLang);
    
    // Set HTML attribute immediately
    document.documentElement.setAttribute('data-genkit-lang', normalizedLang);
    
    // Store preference if it came from URL
    if (urlLang) {
      localStorage.setItem(this.storageKeys.language, normalizedLang);
    }
    
    // If we have a stored language preference but no URL parameter, update the URL
    if (!urlLang && storedLang && normalizedLang !== 'js') {
      const url = new URL(window.location);
      url.searchParams.set('lang', normalizedLang);
      window.history.replaceState({}, '', url);
    }
  }

  normalizeLanguage(lang) {
    const langMap = {
      'js': 'js',
      'javascript': 'js',
      'go': 'go',
      'golang': 'go',
      'python': 'python',
      'py': 'python'
    };
    return langMap[lang.toLowerCase()] || 'js';
  }

  restoreScrollPosition(position) {
    const restore = () => {
      // Restore scroll immediately
      window.scrollTo(0, position);
      
      // Show content quickly after scroll
      requestAnimationFrame(() => {
        document.documentElement.classList.remove('scroll-restoring');
        this.isRestoring = false;
      });
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', restore);
    } else {
      restore();
    }

    // Fallback to ensure content is always visible
    setTimeout(() => {
      if (this.isRestoring) {
        document.documentElement.classList.remove('scroll-restoring');
        this.isRestoring = false;
      }
    }, 100);
  }

  setupEventListeners() {
    // Store scroll position before page unload
    const storeScrollPosition = () => {
      const scrollY = window.scrollY || window.pageYOffset;
      if (scrollY > 0) {
        const scrollKey = this.storageKeys.scroll + window.location.pathname;
        sessionStorage.setItem(scrollKey, scrollY.toString());
      }
    };

    window.addEventListener('beforeunload', storeScrollPosition);
    window.addEventListener('pagehide', storeScrollPosition);

    // Handle language selector clicks
    document.addEventListener('click', (event) => {
      const langButton = event.target.closest('[data-lang]');
      if (langButton && langButton.classList.contains('lang-pill')) {
        event.preventDefault();
        this.setLanguage(langButton.dataset.lang);
      }
    });

    // Handle browser back/forward
    window.addEventListener('popstate', () => {
      this.setupLanguage();
      this.updateLanguageUI();
    });

    // Update language UI when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => this.updateLanguageUI());
    } else {
      this.updateLanguageUI();
    }
  }

  setLanguage(lang) {
    const normalizedLang = this.normalizeLanguage(lang);
    
    // Update URL
    const url = new URL(window.location);
    if (normalizedLang === 'js') {
      url.searchParams.delete('lang');
    } else {
      url.searchParams.set('lang', normalizedLang);
    }
    
    window.history.replaceState({}, '', url);
    
    // Store preference
    localStorage.setItem(this.storageKeys.language, normalizedLang);
    
    // Update HTML attribute
    document.documentElement.setAttribute('data-genkit-lang', normalizedLang);
    
    // Update UI
    this.updateLanguageUI();
  }

  updateLanguageUI() {
    const currentLang = document.documentElement.getAttribute('data-genkit-lang') || 'js';
    
    // Update language selector pills
    document.querySelectorAll('.lang-pill').forEach(pill => {
      const isActive = pill.dataset.lang === currentLang;
      pill.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });
  }

  // Public method to get current language
  getCurrentLanguage() {
    return document.documentElement.getAttribute('data-genkit-lang') || 'js';
  }

  // Public method to manually set language
  setLanguagePublic(language) {
    this.setLanguage(language);
  }
}

// Initialize the unified page manager
const unifiedPageManager = new UnifiedPageManager();

// Make it globally available for debugging and compatibility
window.unifiedPageManager = unifiedPageManager;

// Legacy compatibility for existing language preference enhancer
window.languagePreferenceEnhancer = {
  getCurrentLanguage: () => unifiedPageManager.getCurrentLanguage(),
  setLanguage: (lang) => unifiedPageManager.setLanguagePublic(lang)
};
</script>

<!-- Critical CSS to prevent FOUC and scroll flash -->
<style is:inline>
/* Selective hiding during scroll restoration - only hide main content */
html.scroll-restoring main,
html.scroll-restoring .sl-markdown-content {
  opacity: 0;
  transition: opacity 0.05s ease-out;
}

/* Keep header, sidebar, and other navigation visible */
html.scroll-restoring .header,
html.scroll-restoring .sidebar-pane,
html.scroll-restoring .right-sidebar {
  opacity: 1 !important;
}

/* Hide ALL language content by default */
.lang-content {
  display: none !important;
  visibility: hidden !important;
}

/* Show ONLY the content for the current language */
html[data-genkit-lang="js"] .lang-content[data-lang="js"] {
  display: block !important;
  visibility: visible !important;
}

html[data-genkit-lang="go"] .lang-content[data-lang="go"] {
  display: block !important;
  visibility: visible !important;
}

html[data-genkit-lang="python"] .lang-content[data-lang="python"] {
  display: block !important;
  visibility: visible !important;
}

/* Language selector pills styling */
.lang-pill {
  background: var(--sl-color-bg, #fff);
  color: var(--sl-color-text, #000);
  border: 1px solid var(--sl-color-gray-4, #ccc);
}

html[data-genkit-lang="js"] .lang-pill[data-lang="js"],
html[data-genkit-lang="go"] .lang-pill[data-lang="go"],
html[data-genkit-lang="python"] .lang-pill[data-lang="python"] {
  background: var(--sl-color-accent, #0066cc) !important;
  color: var(--sl-color-white, #fff) !important;
  border-color: var(--sl-color-accent, #0066cc) !important;
}
</style>
