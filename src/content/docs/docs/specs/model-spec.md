# Genkit Model Specification

This document defines the data models and expected behaviors for Genkit Models. It serves as the standard for implementing Genkit support in different programming languages (Node.js, Go, Python) and ensures consistent behavior for tooling and UI.

The schemas defined here are the canonical representation of data flowing into and out of Model Plugins.

## Core Concepts

### Message
A `Message` is the fundamental unit of communication in a conversation history.

- **Role**: Indicates the sender of the message.
  - `system`: System instructions or context setting.
  - `user`: Input from the end-user.
  - `model`: Output generated by the model.
  - `tool`: Result of a tool execution.
- **Content**: A list of `Part` objects representing the message payload. A message can contain multiple parts (multimodal).
- **Metadata**: Arbitrary key-value pairs for additional context (e.g., timestamps, source identifiers).

### Part
The `Part` is a union type representing a discrete piece of content within a message. Models must handle these part types or gracefully reject/convert them if unsupported.

**Metadata:** All parts support a `metadata` field (key-value pairs) for storing provider-specific auxiliary information that doesn't fit into the main schema (e.g., timing info, log probabilities, or internal identifiers like Gemini's `thoughtSignature`).

#### Text Part
Plain text content.
- `text`: The string content.

**Example:**
```json
{
  "text": "Hello, how can I help you today?",
  "metadata": {
    "thoughtSignature": "g-1234567890"
  }
}
```

#### Media Part
Represents binary media (images, audio, video).
- `media`:
  - `contentType`: MIME type (e.g., `image/jpeg`).
  - `url`: A URI to the content.
    - **MUST** support `data:` URIs (base64 encoded).
    - **MAY** support `http(s):` URIs (depending on provider capabilities).

**Example:**
```json
{
  "media": {
    "contentType": "image/png",
    "url": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
  },
  "metadata": {
    "thoughtSignature": "g-1234567890"
  }
}
```

#### Tool Request Part
A request from the model to execute a specific tool (function calling).
- `toolRequest`:
  - `name`: The name of the tool to call.
  - `input`: The arguments/parameters for the tool (JSON object).
  - `ref`: (Optional) A unique identifier for this specific call instance. Essential for mapping responses back to requests in parallel execution scenarios.
  - `partial`: (Optional) Boolean indicating if this is a partial tool request (used during streaming).

**Streaming Behavior:**
When streaming a tool request, intermediate chunks **MUST** have `partial: true`. Once the tool request is fully generated, the final chunk for that tool request **MUST** contain the complete input and **MUST NOT** have the `partial` field set.

**Example (Complete):**
```json
{
  "toolRequest": {
    "name": "getWeather",
    "input": { "city": "Seattle", "units": "metric" },
    "ref": "call_abc123"
  },
  "metadata": {
    "thoughtSignature": "g-1234567890"
  }
}
```

**Example (Streaming Sequence):**
*Chunk 1:*
```json
{
  "toolRequest": {
    "name": "getWeather",
    "input": { "city": "Sea" },
    "partial": true
  },
  "metadata": {
    "thoughtSignature": "g-1234567890"
  }
}
```
*Chunk 2 (Final):*
```json
{
  "toolRequest": {
    "name": "getWeather",
    "input": { "city": "Seattle", "units": "metric" },
    "ref": "call_abc123"
  },
  "metadata": {
    "thoughtSignature": "g-1234567890"
  }
}
```

#### Tool Response Part
The output of a tool execution, sent back to the model.
- `toolResponse`:
  - `name`: The name of the tool that was called.
  - `output`: The result of the tool execution (JSON object).
  - `ref`: (Optional) Must match the `ref` of the corresponding `Tool Request Part`.

**Example:**
```json
{
  "toolResponse": {
    "name": "getWeather",
    "output": { "temperature": 15, "condition": "Cloudy" },
    "ref": "call_abc123"
  },
  "metadata": {
    "thoughtSignature": "g-1234567890"
  }
}
```

#### Reasoning Part
(Optional) Explicit reasoning or "thought" trace exposed by some models (e.g., Chain of Thought).
- `reasoning`: Text content representing the model's internal reasoning process.

**Example:**
```json
{
  "reasoning": "The user is asking about the weather. I should check the available tools to see if I can retrieve weather data.",
  "metadata": {
    "thoughtSignature": "g-1234567890"
  }
}
```

#### Custom Part
Provider-specific extensions that don't fit into standard types.
- `custom`: A dictionary of arbitrary data. Tooling may not render this natively.

**Example:**
```json
{
  "custom": {
    "myProviderSpecificField": "someValue"
  },
  "metadata": {
    "thoughtSignature": "g-1234567890"
  }
}
```

## Model Interface

A Model Plugin implements an action that accepts a `GenerateRequest` and returns a `GenerateResponse`.

### Generate Request
The standard input payload for a model generation.

- **messages**: List of `Message` objects representing the conversation history.
- **tools**: (Optional) List of `ToolDefinition` objects available to the model.
  - `name`: Tool identifier.
  - `description`: Human-readable description.
  - `inputSchema`: JSON Schema defining the expected arguments.
  - `outputSchema`: (Optional) JSON Schema describing the return value.
- **config**: (Optional) Free-form configuration object (validated by the model's specific config schema). Common fields include:
  - `temperature`
  - `maxOutputTokens`
  - `topK`
  - `topP`
  - `stopSequences`
- **toolChoice**: Controls tool usage behavior (`auto`, `required`, `none`).
- **output**: (Optional) Constraints on the generated output.
  - `format`: e.g., `json`.
  - `schema`: A JSON Schema the output must conform to.
  - `constrained`: Boolean indicating if the model should enforce the schema strictly.

### Generate Response
The standard output payload from a model generation.

- **message**: The generated `Message`. usually with role `model`.
  - Content may include `Text Part`s and/or `Tool Request Part`s.
- **finishReason**: Why the generation stopped.
  - `stop`: Natural completion or stop sequence encountered.
  - `length`: Maximum token limit reached.
  - `blocked`: Content policy violation.
  - `other`: Unknown or provider-specific reason.
- **usage**: (Optional) Token usage statistics.
  - `inputTokens`, `outputTokens`, `totalTokens`.
- **custom**: (Optional) Provider-specific raw response data.

## Behavioral Expectations

### Capabilities & Declaration
Models declare their capabilities (e.g., `multiturn`, `media`, `tools`, `systemRole`, `constrained`). The Genkit framework uses this declaration to determine how to preprocess the request.
- If a model declares `constrained: true`, it **MUST** handle `output.schema` natively.
- If a model declares `systemRole: false`, the framework **MAY** merge system messages into the user prompt before calling the plugin, or the plugin **MUST** handle the simulation itself.

### Structured Output
When `output` constraints are provided in the `GenerateRequest`:

1.  **Format (`json`)**: If `output.format` is `'json'`, the model **SHOULD** ensure the output is valid JSON, utilizing "JSON mode" if the provider supports it.
2.  **Schema (`output.schema`)**:
    -   If the model has declared support for constrained generation, it will receive the `schema` in the request. The plugin **MUST** pass this schema to the provider to enforce valid output generation.
    -   If the model has *not* declared support, the Genkit framework (via middleware) will likely have already converted the schema into text instructions appended to the prompt, and removed the `schema` field from the request. In this case, the plugin simply processes the prompt as text.

### System Messages
If a provider does not natively support a "system" role, and the framework has not already handled it (based on capabilities), the Model Plugin **MUST** simulate it.
- **Strategy**: Prepend the system message content to the beginning of the first user message, or insert it as the first message in the history with a `user` role (potentially with a separator).

### Tool Usage
1.  **Definition**: The plugin **MUST** convert Genkit `ToolDefinition` (JSON Schema) to the provider's specific format.
2.  **Request**: When the provider signals a function call, the plugin **MUST** convert this to a `Tool Request Part`.
3.  **Response**: The plugin **MUST** be able to accept `Tool Response Part`s in the message history and format them correctly for the provider (e.g., as a specific role or message type).

### Streaming
If streaming is requested:
1.  **Chunks**: The plugin **MUST** yield `GenerateResponseChunk` objects as data becomes available.
    - **Chunk Structure**:
      - `content`: A list of `Part` objects. These parts may be partial (e.g., a fragment of a text string).
      - `index`: Candidate index (default 0).
2.  **Aggregation**: The Model Plugin **MUST** return the complete, aggregated `GenerateResponse` at the end of execution. The `streamingCallback` is for intermediate updates only; the final return value must always be the full response, ensuring the model abstraction behaves consistently whether streaming is enabled or not.
