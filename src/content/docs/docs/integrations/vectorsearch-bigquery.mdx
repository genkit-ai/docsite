---
title: Vertex AI Vector Search with Bigquery
description: Learn how to use Vertex AI Vector Search with Bigquery using Genkit.
---

import LanguageSelector from '../../../../components/LanguageSelector.astro';
import CopyMarkdownButton from '../../../../components/CopyMarkdownButton.astro';
import LanguageContent from '../../../../components/LanguageContent.astro';

<div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin: 1rem 0 1rem 0;">
  <LanguageSelector />
  <CopyMarkdownButton />
</div>

<LanguageContent lang="python">

Vertex AI Vector Search allows you to index and retrieve documents. The documents are stored in BigQuery and the corresponding document IDs are indexed using the vector search index provided by Vertex AI. These are suitable for production use cases.

## Installation

```bash
uv add genkit-plugin-vertex-ai
```

## Prerequisites

1. Create a Vertex AI Vector Search index. Details on creating an index can be found at [Create your Vector Search Index](https://cloud.google.com/vertex-ai/docs/vector-search/create-manage-index#create-index)
2. Create a BigQuery Dataset and a Table within that dataset to store the documents that will be indexed. More information to create BigQuery datasets is available [here](https://cloud.google.com/bigquery/docs/datasets)

## Configuration

To use Vertex AI Vector Search with BigQuery, use the `define_vertex_vector_search_big_query()` helper function:

```python
from genkit import Genkit
from genkit.plugins.google_genai import VertexAI
from genkit.plugins.vertex_ai import define_vertex_vector_search_big_query
from google.cloud import bigquery

# Initialize plugins
ai = Genkit(
    plugins=[VertexAI(location='us-central1')],
)

# Create BigQuery client
bq_client = bigquery.Client()

# Define the retriever
retriever_name = define_vertex_vector_search_big_query(
    ai,
    name='my_vertex_bigquery_retriever',
    embedder='vertexai/text-embedding-004',
    bq_client=bq_client,
    dataset_id='my_dataset',
    table_id='documents',
)
```

### Configuration Options

- **name** (str): A unique name for this retriever instance.
- **embedder** (str): The embedding model to use (e.g., `'vertexai/text-embedding-004'`).
- **bq_client**: A `google.cloud.bigquery.Client` object for database queries.
- **dataset_id** (str): The ID of the BigQuery dataset.
- **table_id** (str): The ID of the BigQuery table.
- **embedder_options** (optional): Configuration to pass to the embedder.
- **match_service_client_generator** (optional): Custom generator for the Vertex AI Match Service client.

## Usage

### Indexing Documents

To populate your BigQuery table with documents and vector search index:

```python
from genkit import Genkit
from genkit.plugins.google_genai import VertexAI
from google.cloud import bigquery

ai = Genkit(
    plugins=[VertexAI(location='us-central1')],
)

bq_client = bigquery.Client()

async def index_documents_to_bigquery(documents: list[str], dataset_id: str, table_id: str):
    """Index documents in BigQuery with Vertex AI Vector Search.

    Args:
        documents: List of text documents to index.
        dataset_id: BigQuery dataset ID.
        table_id: BigQuery table ID.
    """
    rows_to_insert = []
    
    for i, text in enumerate(documents):
        # Generate embedding
        embedding_result = await ai.embed(
            embedder='vertexai/text-embedding-004',
            content=text,
        )
        embedding = embedding_result[0].embedding
        
        # Create document record
        doc_id = f'doc-{i}'
        rows_to_insert.append({
            'id': doc_id,  # Required for vector search
            'content': text,
            'embedding': embedding,
        })
    
    # Insert rows into BigQuery
    table_ref = bq_client.dataset(dataset_id).table(table_id)
    errors = bq_client.insert_rows_json(table_ref, rows_to_insert)
    
    if errors:
        print(f"Errors occurred while inserting rows: {errors}")
    else:
        print(f"Successfully indexed {len(rows_to_insert)} documents")

# Example usage
# documents = [
#     "Machine learning is a subset of artificial intelligence.",
#     "Deep learning uses neural networks with multiple layers.",
#     "Natural language processing enables computers to understand text.",
# ]
# import asyncio
# asyncio.run(index_documents_to_bigquery(documents, 'my_dataset', 'documents'))
```

### Retrieving Documents

Use the retriever you defined to search for relevant documents:

```python
@ai.flow()
async def vector_search_flow(query: str) -> str:
    """Search using Vertex AI Vector Search with BigQuery.

    Args:
        query: The search query.

    Returns:
        Generated response based on retrieved documents.
    """
    # Retrieve relevant documents
    results = await ai.retrieve(
        retriever='my_vertex_bigquery_retriever',
        query=query,
        options={'limit': 5},
    )

    # Use retrieved documents for generation
    context = '\n\n'.join([
        doc.text()
        for doc in results.documents
    ])
    
    response = await ai.generate(
        prompt=f"""Based on the following context, answer the question:

Context:
{context}

Question: {query}

Answer:""",
    )
    
    return response.text
```

### Complete RAG Example

Here's a complete example showing the full workflow:

```python
from genkit import Genkit
from genkit.plugins.google_genai import VertexAI
from genkit.plugins.vertex_ai import define_vertex_vector_search_big_query
from google.cloud import bigquery

# Initialize
ai = Genkit(
    plugins=[VertexAI(location='us-central1')],
)

bq_client = bigquery.Client()

# Define retriever
retriever_name = define_vertex_vector_search_big_query(
    ai,
    name='knowledge_base',
    embedder='vertexai/text-embedding-004',
    bq_client=bq_client,
    dataset_id='my_dataset',
    table_id='knowledge_base',
)

@ai.flow()
async def rag_qa_flow(question: str) -> str:
    """Answer questions using RAG with Vertex AI Vector Search.

    Args:
        question: The question to answer.

    Returns:
        The answer based on retrieved context.
    """
    # Step 1: Retrieve relevant documents
    results = await ai.retrieve(
        retriever='knowledge_base',
        query=question,
        options={'limit': 3},
    )
    
    # Step 2: Prepare context from retrieved documents
    context = '\n\n'.join([
        f"Document {i+1}: {doc.text()}"
        for i, doc in enumerate(results.documents)
    ])
    
    # Step 3: Generate answer with context
    response = await ai.generate(
        model='vertexai/gemini-2.0-flash',
        prompt=f"""Use the following context to answer the question. If the answer cannot be found in the context, say so.

Context:
{context}

Question: {question}

Answer:""",
    )
    
    return response.text
```

## Learn More

- See the [Retrieval-augmented generation](/docs/rag) page for a general discussion on indexers and retrievers in Genkit.
- See [Vertex AI Vector Search documentation](https://cloud.google.com/vertex-ai/docs/vector-search/overview) for more details on the service.

</LanguageContent>

<LanguageContent lang="js">

Vertex AI Vector Search allows you to index and retrieve documents. The documents are stored in Bigquery and the corresponding document IDs are indexed using the vector search index provided by Vertex AI. These are suitable for production use cases.

## Installation

```bash
npm install @genkit-ai/vertexai
```

## Configuration

1. Create a Vertex AI Vector Search index. Details on creating an index can be found at [Create your Vector Search Index](https://cloud.google.com/vertex-ai/docs/vector-search/create-manage-index#create-index)
2. Create a Bigquery Dataset and a Table within that dataset to store the documents that will be indexed. More information to create Bigquery datasets is available [here](https://cloud.google.com/bigquery/docs/datasets)

To use Vertex AI Vector Search with Bigquery, initialize it and define a retriever with an embedder. You can also use a custom indexer and retriever for indexing and retrieving documents from the Bigquery dataset:

```ts
import { BigQuery } from '@google-cloud/bigquery';

const bq = new BigQuery({
  projectId: PROJECT_ID,
});

const bigQueryDocumentRetriever: DocumentRetriever =
  getBigQueryDocumentRetriever(bq, BIGQUERY_TABLE, BIGQUERY_DATASET);

const bigQueryDocumentIndexer: DocumentIndexer = getBigQueryDocumentIndexer(
  bq,
  BIGQUERY_TABLE,
  BIGQUERY_DATASET
);

// Configure Genkit with Vertex AI plugin
const ai = genkit({
  plugins: [
    vertexAI({
      projectId: PROJECT_ID,
      location: LOCATION,
      googleAuth: {
        scopes: ['https://www.googleapis.com/auth/cloud-platform'],
      },
    }),
    vertexAIVectorSearch({
      location: LOCATION,
      projectId: PROJECT_ID,
      embedder: textEmbedding004,
      vectorSearchOptions: [
        {
          publicDomainName: VECTOR_SEARCH_PUBLIC_DOMAIN_NAME,
          indexEndpointId: VECTOR_SEARCH_INDEX_ENDPOINT_ID,
          indexId: VECTOR_SEARCH_INDEX_ID,
          deployedIndexId: VECTOR_SEARCH_DEPLOYED_INDEX_ID,
          documentRetriever: bigQueryDocumentRetriever,
          documentIndexer: bigQueryDocumentIndexer,
        },
      ],
    }),
  ],
});
```

### Configuration Options

- **projectId** (string): GCP Project ID
- **location** (string): GCP Project location
- **indexId** (string): Vector search index id
- **indexEndpointId** (string): Vector search endpoint id corresponding to the vector search index. More details can be found [here](https://cloud.google.com/vertex-ai/docs/vector-search/deploy-index-public#create-index-endpoint).
- **deployedIndexId** (string): Vector search deployed index id corresponding to the vector search endpoint. More details to deploy an index to an index endpoint can be found [here](https://cloud.google.com/vertex-ai/docs/vector-search/deploy-index-public#deploy-index).
- **publicDomainName** (string): Public Domain Name of the vector search index endpoint.
- **embedder** ([`ai.Embedder`](https://pkg.go.dev/github.com/firebase/genkit/go/ai#Embedder)): The embedding model to use. Must be a configured embedder in your Genkit project.
- **documentIndexer** (`func(ctx context.Context, docs []*ai.Document) ([]string, error)`): Document indexer used to insert data with unique IDs in Bigquery. This can be a custom document indexer as well depending on the user's requirement.
- **documentRetriever** (`func(ctx context.Context, neighbors []Neighbor, options any) ([]*ai.Document, error)`): Document retriever used to retrieve data with corresponding ID from Bigquery. This can be a custom document retriever as well depending on the user's requirement.
## Usage

### Indexing Documents

To populate with data, you need to implement your own indexing logic using the [`ai.Document`](https://pkg.go.dev/github.com/firebase/genkit/go/ai#Document) format. Genkit provides a sample indexing function as well:

```ts
async ({ texts }) => {
const documents = texts.map((text) => Document.fromText(text));
await ai.index({
    indexer: vertexAiIndexerRef({
    indexId: VECTOR_SEARCH_INDEX_ID,
    displayName: 'bigquery_index',
    }),
    documents,
});
return { result: 'success' };
}
```

### Retrieving Documents

Use [`ai.Retrieve`](https://pkg.go.dev/github.com/firebase/genkit/go/ai#Retrieve) with the retriever you defined:

```ts
async ({ query, k }) => {
    const startTime = performance.now();
    const queryDocument = Document.fromText(query);
    const res = await ai.retrieve({
        retriever: vertexAiRetrieverRef({
        indexId: VECTOR_SEARCH_INDEX_ID,
        displayName: 'bigquery_index',
        }),
        query: queryDocument,
        options: { k },
    });
    const endTime = performance.now();
    return {
        result: res
        .map((doc) => ({
            text: doc.content[0].text!,
            distance: doc.metadata?.distance,
        }))
        .sort((a, b) => b.distance - a.distance),
        length: res.length,
        time: endTime - startTime,
    };
}
```

</LanguageContent>

<LanguageContent lang="go">

Vertex AI Vector Search allows you to index and retrieve documents. The documents are stored in Bigquery and the corresponding document IDs are indexed using the vector search index provided by Vertex AI. These are suitable for production use cases.

## Installation

The vector search functionality is built into Genkit Go. You need to import the [`vectorsearch`](https://pkg.go.dev/github.com/firebase/genkit/go/plugins/vertexai/vectorsearch) package:

```go
import "github.com/firebase/genkit/go/plugins/vertexai/vectorsearch"
```

## Configuration

1. Create a Vertex AI Vector Search index. Details on creating an index can be found at [Create your Vector Search Index](https://cloud.google.com/vertex-ai/docs/vector-search/create-manage-index#create-index)
2. Create a Bigquery Dataset and a Table within that dataset to store the documents that will be indexed. More information to create Bigquery datasets is available [here](https://cloud.google.com/bigquery/docs/datasets)

To use Vertex AI Vector Search with Bigquery, initialize it and define a retriever with an embedder. You can also use a custom indexer and retriever for indexing and retrieving documents from the Bigquery dataset:

```go
import (
	"context"
	"log"

	"cloud.google.com/go/bigquery"
	"github.com/firebase/genkit/go/ai"
	"github.com/firebase/genkit/go/genkit"
	"github.com/firebase/genkit/go/plugins/googlegenai"
	"github.com/firebase/genkit/go/plugins/vertexai/vectorsearch"
)

ctx := context.Background()

g := genkit.Init(ctx, genkit.WithPlugins(&googlegenai.VertexAI{}))

bqClient, err := bigquery.NewClient(ctx, "your-project-id")
if err != nil {
    log.Fatalf("Failed to create BigQuery client: %v", err)
}

documentIndexer := vectorsearch.GetBigQueryDocumentIndexer(bqClient, "your-dataset-id", "your-table-id")
documentRetriever := vectorsearch.GetBigQueryDocumentRetriever(bqClient, "your-dataset-id", "your-table-id")

vectorsearchParams := &VectorsearchConfig{
    ProjectID:         vectorsearchPlugin.ProjectID,
    Location:          vectorsearchPlugin.Location,
    IndexID:           "${VECTOR_SEARCH_INDEX_ID}",                           // Replace with your index ID
    IndexEndpointID:   "${VECTOR_SEARCH_INDEX_ENDPOINT_ID}",                  // Replace with your index endpoint ID
    DeployedIndexID:   "${VECTOR_SEARCH_DEPLOYED_INDEX_ID}",                  // Replace with your deployed index ID
    ProjectNumber:     "${GOOGLE_CLOUD_PROJECT_NUMBER}",                      // Replace with your Google Cloud project number
    PublicDomainName:  "${VECTOR_SEARCH_PUBLIC_DOMAIN_NAME}",                 // Replace with your public domain name
    Embedder:          googlegenai.VertexAIEmbedder(g, "text-embedding-004"), // Replace with your desired embedder
    NeighborsCount:    10,                                                    // Number of neighbors to retrieve
    DocumentIndexer:   documentIndexer,
    DocumentRetriever: documentRetriever,
}
```

### Configuration Options

- **ProjectID** (string): GCP Project ID
- **Location** (string): GCP Project location
- **IndexID** (string): Vector search index id
- **IndexEndpointID** (string): Vector search endpoint id corresponding to the vector search index. More details can be found [here](https://cloud.google.com/vertex-ai/docs/vector-search/deploy-index-public#create-index-endpoint).
- **DeployedIndexID** (string): Vector search deployed index id corresponding to the vector search endpoint. More details to deploy an index to an index endpoint can be found [here](https://cloud.google.com/vertex-ai/docs/vector-search/deploy-index-public#deploy-index).
- **ProjectNumber** (string): GCP Project Number
- **PublicDomainName** (string): Public Domain Name of the vector search index endpoint.
- **Embedder** ([`ai.Embedder`](https://pkg.go.dev/github.com/firebase/genkit/go/ai#Embedder)): The embedding model to use. Must be a configured embedder in your Genkit project.
- **NeighborsCount** (int): Number of neighbors to set in the vector search
- **DocumentIndexer** (`func(ctx context.Context, docs []*ai.Document) ([]string, error)`): Document indexer used to insert data with unique IDs in Bigquery. This can be a custom document indexer as well depending on the user's requirement.
- **DocumentRetriever** (`func(ctx context.Context, neighbors []Neighbor, options any) ([]*ai.Document, error)`): Document retriever used to retrieve data with corresponding ID from Bigquery. This can be a custom document retriever as well depending on the user's requirement.
## Usage

### Indexing Documents

To populate with data, you need to implement your own indexing logic using the [`ai.Document`](https://pkg.go.dev/github.com/firebase/genkit/go/ai#Document) format. Genkit provides a sample indexing function as well:

```go
import (
    "github.com/firebase/genkit/go/ai"
)

// Create documents from text
data := []string{
    "This is the first document.",
    "This is the second document.",
    "This is the third document.",
    "This is the fourth document.",
}

var docs []*ai.Document
for _, text := range data {
	docs = append(docs, ai.DocumentFromText(text, nil))
}

// Index the docs.
// Custom Index function can be used which should internally refer the indexer function for Bigquery
if err := vectorsearch.Index(ctx, g, vectorsearch.IndexParams{
    IndexID:         vectorsearchParams.IndexID,
    Embedder:        vectorsearchParams.Embedder,
    EmbedderOptions: nil,
    Docs:            docs,
    ProjectID:       vectorsearchParams.ProjectID,
    Location:        vectorsearchParams.Location,
}, vectorsearchParams.DocumentIndexer); err != nil {
    return nil, err
}
```

### Retrieving Documents

Use [`ai.Retrieve`](https://pkg.go.dev/github.com/firebase/genkit/go/ai#Retrieve) with the retriever you defined:

```go
// Define the retriever for vector search.
retriever, err := vectorsearch.DefineRetriever(ctx, g, vectorsearch.Config{
    IndexID: vectorsearchParams.IndexID, // Replace with your index ID
}, nil)
if err != nil {
    log.Fatal(err)
}

// The retriever defined above has built in function called Retrieve() which 
// corresponds to vector search retriever function defined in vector search plugin.
// The DocumentRetriever passed as argument corresponds to the documentretriever 
// for Bigquery. This function retrieves the docs corresponding to the Neighbor IDs
// found using vector search index.

resp, err := retriever.Retrieve(ctx, &ai.RetrieverRequest{
    Query: ai.DocumentFromText(input.Question, nil),
    Options: &vectorsearch.RetrieveParams{
        Embedder:          vectorsearchParams.Embedder,
        NeighborCount:     vectorsearchParams.NeighborsCount,
        IndexEndpointID:   vectorsearchParams.IndexEndpointID,
        DeployedIndexID:   vectorsearchParams.DeployedIndexID,
        PublicDomainName:  vectorsearchParams.PublicDomainName,
        ProjectNumber:     vectorsearchParams.ProjectNumber,
        DocumentRetriever: vectorsearchParams.DocumentRetriever,
    }})
if err != nil {
    return nil, err
}
```

</LanguageContent>
